name: benchmark comment

on:
  workflow_run:
    workflows: ["benchmarks"]
    types: [completed]

permissions:
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'

    steps:
      - name: Download benchmark artifacts
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          name: benchmark-results

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Artifacts may have itest/ prefix from upload path
            let comparisonPath = 'itest/comparison.json';
            if (!fs.existsSync(comparisonPath)) comparisonPath = 'comparison.json';
            const comparison = JSON.parse(fs.readFileSync(comparisonPath, 'utf8'));

            let prPath = 'itest/pr_number.txt';
            if (!fs.existsSync(prPath)) prPath = 'pr_number.txt';
            const prNumber = parseInt(fs.readFileSync(prPath, 'utf8').trim(), 10);

            let comment = '## Benchmark Results\n\n';

            const { regressions, improvements, new: newBenchmarks, total } = comparison.summary;

            if (regressions > 0) {
              comment += `> **${regressions} performance regression(s) detected**\n\n`;
            } else if (improvements > 0) {
              comment += `> **${improvements} performance improvement(s) detected**\n\n`;
            } else if (newBenchmarks === total) {
              comment += `> **First benchmark run** - ${total} benchmarks baselined\n\n`;
            } else {
              comment += `> **Performance is stable** - no significant changes\n\n`;
            }

            comment += '| Benchmark | PR | Base | Change |\n';
            comment += '|-----------|-----|------|--------|\n';

            for (const bench of comparison.benchmarks) {
              let changeStr = '';

              if (bench.status === 'new') {
                changeStr = '*new*';
              } else if (bench.change_pct !== null) {
                let icon = '';
                if (bench.status === 'regression') icon = 'ðŸ”´';
                else if (bench.status === 'slower') icon = 'ðŸŸ¡';
                else if (bench.status === 'faster') icon = 'ðŸŸ¢';

                const sign = bench.change_pct > 0 ? '+' : '';
                changeStr = `${icon} ${sign}${bench.change_pct.toFixed(1)}%`;
              }

              const baseline = bench.baseline || '-';
              comment += `| \`${bench.name}\` | ${bench.current} | ${baseline} | ${changeStr} |\n`;
            }

            comment += '\n<details>\n<summary>About these benchmarks</summary>\n\n';
            comment += '- Baseline and PR benchmarks run on the **same machine** in a single CI job\n';
            comment += '- Regression threshold: >10%, Caution: >5%, Improvement: <-5%\n';
            comment += '</details>\n';

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Benchmark Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment,
              });
            }
