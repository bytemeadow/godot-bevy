name: ci

on:
    push:
        branches: [main, develop]
        paths-ignore:
            - "book/**"
            - "**.md"
            - "!**/Cargo.toml"
            - ".github/workflows/book.yml"
            - ".github/workflows/benchmark*.yml"
    pull_request:
        branches: [main, develop]
        paths-ignore:
            - "book/**"
            - "**.md"
            - "!**/Cargo.toml"
            - ".github/workflows/book.yml"
            - ".github/workflows/benchmark*.yml"

env:
    CARGO_TERM_COLOR: always
    GODOT_VERSION: "4.5.1"

permissions:
    contents: read
    issues: write
    pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Fast-fail lint job - runs once on Linux, catches formatting/clippy errors quickly
    lint:
        name: lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt, clippy

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: . -> target

            - name: Cache and install Linux dependencies
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: libasound2-dev libudev-dev pkg-config
                  version: 1.0

            - name: Check formatting
              run: cargo fmt --all -- --check

            - name: Run clippy
              run: cargo clippy --all-targets -- -D warnings

    # Test job - runs on all platforms after lint passes (parallel with build)
    test:
        name: test (${{ matrix.platform }})
        runs-on: ${{ matrix.os }}
        needs: lint
        strategy:
            matrix:
                os:
                    [
                        blaze/compute/ubuntu-latest-amd64,
                        blaze/macos-latest,
                        windows-latest,
                    ]
                include:
                    - os: blaze/compute/ubuntu-latest-amd64
                      platform: linux
                    - os: blaze/macos-latest
                      platform: macos
                    - os: windows-latest
                      platform: windows

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: . -> target

            - name: Cache and install Linux dependencies
              if: runner.os == 'linux'
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: libasound2-dev libudev-dev pkg-config
                  version: 1.0

            - name: Run unit tests
              run: cargo test --lib --bins --examples

    # Build job - runs on all platforms after lint passes (parallel with test)
    build:
        name: build (${{ matrix.platform }})
        runs-on: ${{ matrix.os }}
        needs: lint
        env:
            # Disable debug symbols in release builds to save disk space
            CARGO_PROFILE_RELEASE_DEBUG: false
        strategy:
            matrix:
                os:
                    [
                        blaze/compute/ubuntu-latest-amd64,
                        blaze/macos-latest,
                        windows-latest,
                    ]
                include:
                    - os: blaze/compute/ubuntu-latest-amd64
                      platform: linux
                      target: x86_64-unknown-linux-gnu
                      extension: .so
                    - os: blaze/macos-latest
                      platform: macos
                      target: x86_64-apple-darwin
                      extension: .dylib
                    - os: windows-latest
                      platform: windows
                      target: x86_64-pc-windows-msvc
                      extension: .dll

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: |
                      . -> target
                      examples/*/rust -> target

            - name: Cache and install Linux dependencies
              if: runner.os == 'linux'
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: libasound2-dev libudev-dev pkg-config
                  version: 1.0

            - name: Build release
              run: cargo build --release -p godot-bevy -p godot-bevy-macros

            - name: Upload Rust libraries
              uses: actions/upload-artifact@v4
              with:
                  name: rust-libs-${{ runner.os }}
                  path: |
                      target/release/*rust${{ matrix.extension }}
                      target/release/deps/*rust*${{ matrix.extension }}
                  if-no-files-found: error

    changes:
        name: detect changes
        runs-on: ubuntu-latest
        outputs:
            library: ${{ steps.filter.outputs.library }}
            itest: ${{ steps.filter.outputs.itest }}
            examples: ${{ steps.filter.outputs.changes }}
        steps:
            - uses: actions/checkout@v4
            - uses: dorny/paths-filter@v3
              id: filter
              with:
                  # Output JSON array of changed filter names
                  filters: |
                      library:
                        - 'godot-bevy/**'
                        - 'godot-bevy-macros/**'
                        - 'Cargo.toml'
                        - 'Cargo.lock'
                      itest:
                        - 'itest/**'
                      dodge-the-creeps-2d:
                        - 'godot-bevy/**'
                        - 'godot-bevy-macros/**'
                        - 'examples/dodge-the-creeps-2d/**'
                        - '.github/workflows/ci.yml'
                        - 'Cargo.toml'
                        - 'Cargo.lock'
                      platformer-2d:
                        - 'godot-bevy/**'
                        - 'godot-bevy-macros/**'
                        - 'examples/platformer-2d/**'
                        - '.github/workflows/ci.yml'
                        - 'Cargo.toml'
                        - 'Cargo.lock'

    # Build examples matrix from changed examples
    examples:
        name: build / ${{ matrix.example }}
        runs-on: blaze/macos-latest
        needs: [build, changes]
        # Only run if at least one example filter matched (exclude library/itest from check)
        if: contains(needs.changes.outputs.examples, 'dodge-the-creeps-2d') || contains(needs.changes.outputs.examples, 'platformer-2d')
        strategy:
            fail-fast: false
            matrix:
                # List all exportable examples here
                example: [dodge-the-creeps-2d, platformer-2d]
                exclude:
                    # Exclude examples that didn't change
                    - example: ${{ !contains(needs.changes.outputs.examples, 'dodge-the-creeps-2d') && 'dodge-the-creeps-2d' || 'none' }}
                    - example: ${{ !contains(needs.changes.outputs.examples, 'platformer-2d') && 'platformer-2d' || 'none' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: |
                      . -> target
                      examples/*/rust -> target

            - name: Install Godot
              uses: chickensoft-games/setup-godot@v2
              with:
                  version: ${{ env.GODOT_VERSION }}
                  use-dotnet: false
                  include-templates: true

            - name: Cache Godot imports
              uses: actions/cache@v4
              with:
                  path: examples/${{ matrix.example }}/godot/.godot
                  key: ${{ runner.os }}-godot-imports-${{ matrix.example }}-${{ hashFiles(format('examples/{0}/godot/**/*.import', matrix.example)) }}
                  restore-keys: |
                      ${{ runner.os }}-godot-imports-${{ matrix.example }}-

            - name: Download Rust libraries
              uses: actions/download-artifact@v4
              with:
                  path: artifacts/

            - name: Setup cross-platform libraries
              run: |
                  mkdir -p target/{release,debug}

                  # Copy all platform libraries to target directories
                  find artifacts/ -name "*rust*" -type f | while read file; do
                    cp "$file" target/release/ 2>/dev/null || true
                    cp "$file" target/debug/ 2>/dev/null || true
                  done

                  echo "Available libraries:"
                  ls -la target/release/ || echo "No release libraries found"

            - name: Build example Rust library
              run: cargo build --release --manifest-path examples/${{ matrix.example }}/rust/Cargo.toml

            - name: Import Godot project
              working-directory: examples/${{ matrix.example }}/godot
              run: godot --editor --headless --quit || true

            - name: Export for all platforms
              working-directory: examples/${{ matrix.example }}/godot
              run: |
                  mkdir -p exports
                  godot --headless --export-release "Linux/X11" exports/${{ matrix.example }}-linux
                  godot --headless --export-release "Windows Desktop" exports/${{ matrix.example }}-windows.exe
                  godot --headless --export-release "macOS" exports/${{ matrix.example }}-macos.app

            - name: Upload game exports
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.example }}-exports
                  path: examples/${{ matrix.example }}/godot/exports/
                  if-no-files-found: error

    integration-tests:
        name: integration tests
        runs-on: blaze/macos-latest
        needs: [build, changes]
        if: |
            needs.changes.outputs.library == 'true' ||
            needs.changes.outputs.itest == 'true'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: |
                      . -> target
                      itest/rust -> target

            - name: Install Godot
              uses: chickensoft-games/setup-godot@v2
              with:
                  version: ${{ env.GODOT_VERSION }}
                  use-dotnet: false
                  include-templates: false

            - name: Download Rust libraries
              uses: actions/download-artifact@v4
              with:
                  path: artifacts/

            - name: Setup cross-platform libraries
              run: |
                  mkdir -p target/{release,debug}

                  # Copy all platform libraries to target directories
                  find artifacts/ -name "*rust*" -type f | while read file; do
                    cp "$file" target/release/ 2>/dev/null || true
                    cp "$file" target/debug/ 2>/dev/null || true
                  done

            - name: Cache Godot imports
              uses: actions/cache@v4
              with:
                  path: itest/godot/.godot
                  key: ${{ runner.os }}-godot-imports-itest-${{ hashFiles('itest/godot/**/*.import') }}
                  restore-keys: |
                      ${{ runner.os }}-godot-imports-itest-

            - name: Build integration test library
              run: cargo build --manifest-path itest/rust/Cargo.toml

            - name: Import Godot project
              working-directory: itest/godot
              run: godot --editor --headless --quit || true

            - name: Run integration tests
              working-directory: itest
              env:
                  GODOT4_BIN: godot
              run: ./run-tests.sh
