name: ci

on:
    push:
        branches: [main, develop]
        paths-ignore:
            - "book/**"
            - "**.md"
            - "!**/Cargo.toml"
            - ".github/workflows/book.yml"
            - ".github/workflows/benchmark*.yml"
    pull_request:
        branches: [main, develop]
        paths-ignore:
            - "book/**"
            - "**.md"
            - "!**/Cargo.toml"
            - ".github/workflows/book.yml"
            - ".github/workflows/benchmark*.yml"

env:
    CARGO_TERM_COLOR: always
    GODOT_VERSION: "4.5.1"

permissions:
    contents: read
    issues: write
    pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Fast-fail lint job - runs once on Linux, catches formatting/clippy errors quickly
    lint:
        name: lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt, clippy

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: . -> target

            - name: Cache and install Linux dependencies
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: libasound2-dev libudev-dev pkg-config
                  version: 1.0

            - name: Check formatting
              run: cargo fmt --all -- --check

            - name: Run clippy
              run: cargo clippy --all-targets -- -D warnings

    # Test job - runs on all platforms after lint passes
    test:
        name: test (${{ matrix.platform }})
        runs-on: ${{ matrix.os }}
        needs: [lint, changes]
        if: needs.changes.outputs.library == 'true' || needs.changes.outputs.itest == 'true'
        strategy:
            matrix:
                os:
                    [
                        blaze/compute/ubuntu-latest-amd64,
                        blaze/macos-latest,
                        windows-latest,
                    ]
                include:
                    - os: blaze/compute/ubuntu-latest-amd64
                      platform: linux
                    - os: blaze/macos-latest
                      platform: macos
                    - os: windows-latest
                      platform: windows

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: . -> target

            - name: Cache and install Linux dependencies
              if: runner.os == 'linux'
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: libasound2-dev libudev-dev pkg-config
                  version: 1.0

            - name: Run unit tests
              run: cargo test --lib --bins --examples

    # Build example libraries on all platforms (needed for cross-platform Godot export)
    build-examples:
        name: build examples (${{ matrix.platform }})
        runs-on: ${{ matrix.os }}
        needs: [lint, changes]
        if: contains(needs.changes.outputs.examples, 'dodge-the-creeps-2d') || contains(needs.changes.outputs.examples, 'platformer-2d')
        strategy:
            matrix:
                os:
                    [
                        blaze/compute/ubuntu-latest-amd64,
                        blaze/macos-latest,
                        windows-latest,
                    ]
                include:
                    - os: blaze/compute/ubuntu-latest-amd64
                      platform: linux
                    - os: blaze/macos-latest
                      platform: macos
                    - os: windows-latest
                      platform: windows

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: . -> target

            - name: Cache and install Linux dependencies
              if: runner.os == 'linux'
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: libasound2-dev libudev-dev pkg-config
                  version: 1.0

            - name: Build example libraries
              run: |
                  cargo build --release --manifest-path examples/dodge-the-creeps-2d/rust/Cargo.toml
                  cargo build --release --manifest-path examples/platformer-2d/rust/Cargo.toml

            - name: Upload example libraries
              uses: actions/upload-artifact@v4
              with:
                  name: example-libs-${{ matrix.platform }}
                  path: |
                      target/release/*.so
                      target/release/*.dylib
                      target/release/*.dll
                  if-no-files-found: warn

    # Detect which paths changed to conditionally run downstream jobs
    changes:
        name: detect changes
        runs-on: ubuntu-latest
        outputs:
            library: ${{ steps.filter.outputs.library }}
            itest: ${{ steps.filter.outputs.itest }}
            examples: ${{ steps.filter.outputs.changes }}
        steps:
            - uses: actions/checkout@v4
            - uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      library:
                        - 'godot-bevy/**'
                        - 'godot-bevy-macros/**'
                        - 'Cargo.toml'
                        - 'Cargo.lock'
                      itest:
                        - 'itest/**'
                      dodge-the-creeps-2d:
                        - 'godot-bevy/**'
                        - 'godot-bevy-macros/**'
                        - 'examples/dodge-the-creeps-2d/**'
                        - '.github/workflows/ci.yml'
                        - 'Cargo.toml'
                        - 'Cargo.lock'
                      platformer-2d:
                        - 'godot-bevy/**'
                        - 'godot-bevy-macros/**'
                        - 'examples/platformer-2d/**'
                        - '.github/workflows/ci.yml'
                        - 'Cargo.toml'
                        - 'Cargo.lock'

    # Export examples for all platforms (requires libraries from build-examples)
    examples:
        name: export / ${{ matrix.example }}
        runs-on: blaze/macos-latest
        needs: [build-examples, changes]
        if: contains(needs.changes.outputs.examples, 'dodge-the-creeps-2d') || contains(needs.changes.outputs.examples, 'platformer-2d')
        strategy:
            fail-fast: false
            matrix:
                example: [dodge-the-creeps-2d, platformer-2d]
                exclude:
                    - example: ${{ !contains(needs.changes.outputs.examples, 'dodge-the-creeps-2d') && 'dodge-the-creeps-2d' || 'none' }}
                    - example: ${{ !contains(needs.changes.outputs.examples, 'platformer-2d') && 'platformer-2d' || 'none' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Godot
              uses: chickensoft-games/setup-godot@v2
              with:
                  version: ${{ env.GODOT_VERSION }}
                  use-dotnet: false
                  include-templates: true

            - name: Download all platform libraries
              uses: actions/download-artifact@v4
              with:
                  pattern: example-libs-*
                  path: artifacts/

            - name: Setup cross-platform libraries
              run: |
                  mkdir -p target/release

                  # Copy all platform libraries to target directory
                  find artifacts/ -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) | while read file; do
                    cp "$file" target/release/
                  done

                  echo "Available libraries:"
                  ls -la target/release/

            - name: Cache Godot imports
              uses: actions/cache@v4
              with:
                  path: examples/${{ matrix.example }}/godot/.godot
                  key: ${{ runner.os }}-godot-imports-${{ matrix.example }}-${{ hashFiles(format('examples/{0}/godot/**/*.import', matrix.example)) }}
                  restore-keys: |
                      ${{ runner.os }}-godot-imports-${{ matrix.example }}-

            - name: Import Godot project
              working-directory: examples/${{ matrix.example }}/godot
              run: godot --editor --headless --quit || true

            - name: Export for all platforms
              working-directory: examples/${{ matrix.example }}/godot
              run: |
                  mkdir -p exports
                  godot --headless --export-release "Linux/X11" exports/${{ matrix.example }}-linux
                  godot --headless --export-release "Windows Desktop" exports/${{ matrix.example }}-windows.exe
                  godot --headless --export-release "macOS" exports/${{ matrix.example }}-macos.app

            - name: Upload game exports
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.example }}-exports
                  path: examples/${{ matrix.example }}/godot/exports/
                  if-no-files-found: error

    # Integration tests with Godot runtime
    integration-tests:
        name: integration tests
        runs-on: blaze/macos-latest
        needs: [lint, changes]
        if: |
            needs.changes.outputs.library == 'true' ||
            needs.changes.outputs.itest == 'true'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: |
                      . -> target
                      itest/rust -> target

            - name: Install Godot
              uses: chickensoft-games/setup-godot@v2
              with:
                  version: ${{ env.GODOT_VERSION }}
                  use-dotnet: false
                  include-templates: false

            - name: Cache Godot imports
              uses: actions/cache@v4
              with:
                  path: itest/godot/.godot
                  key: ${{ runner.os }}-godot-imports-itest-${{ hashFiles('itest/godot/**/*.import') }}
                  restore-keys: |
                      ${{ runner.os }}-godot-imports-itest-

            - name: Build integration test library
              run: cargo build --manifest-path itest/rust/Cargo.toml

            - name: Import Godot project
              working-directory: itest/godot
              run: godot --editor --headless --quit || true

            - name: Run integration tests
              working-directory: itest
              env:
                  GODOT4_BIN: godot
              run: ./run-tests.sh
