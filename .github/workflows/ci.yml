name: ci

on:
    push:
        branches: [main, develop]
        paths-ignore:
            - "book/**"
            - "**.md"
            - ".github/workflows/book.yml"
            - ".github/workflows/benchmark*.yml"
            - ".github/workflows/examples.yml"
    pull_request:
        branches: [main, develop]
        paths-ignore:
            - "book/**"
            - "**.md"
            - ".github/workflows/book.yml"
            - ".github/workflows/benchmark*.yml"
            - ".github/workflows/examples.yml"

env:
    CARGO_TERM_COLOR: always
    GODOT_VERSION: "4.5.1"

permissions:
    contents: read
    issues: write
    pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # Fast-fail lint job - runs once on Linux, catches formatting/clippy errors quickly
    lint:
        name: lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt, clippy

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: . -> target

            - name: Cache and install Linux dependencies
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: libasound2-dev libudev-dev pkg-config
                  version: 1.0

            - name: Check formatting
              run: cargo fmt --all -- --check

            - name: Run clippy
              run: cargo clippy --all-targets -- -D warnings

    # Test job - runs on all platforms after lint passes
    test:
        name: test (${{ matrix.platform }})
        runs-on: ${{ matrix.os }}
        needs: [lint, changes]
        if: needs.changes.outputs.library == 'true' || needs.changes.outputs.itest == 'true'
        strategy:
            matrix:
                os:
                    [
                        blaze/compute/ubuntu-latest-amd64,
                        blaze/macos-latest,
                        windows-latest,
                    ]
                include:
                    - os: blaze/compute/ubuntu-latest-amd64
                      platform: linux
                    - os: blaze/macos-latest
                      platform: macos
                    - os: windows-latest
                      platform: windows

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: . -> target

            - name: Cache and install Linux dependencies
              if: runner.os == 'linux'
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: libasound2-dev libudev-dev pkg-config
                  version: 1.0

            - name: Run unit tests
              run: cargo test --lib --bins --examples

    # Detect which paths changed to conditionally run downstream jobs
    changes:
        name: detect changes
        runs-on: ubuntu-latest
        outputs:
            library: ${{ steps.filter.outputs.library }}
            itest: ${{ steps.filter.outputs.itest }}
        steps:
            - uses: actions/checkout@v4
            - uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      library:
                        - 'godot-bevy/**'
                        - 'godot-bevy-macros/**'
                        - '.github/workflows/ci.yml'
                        - 'Cargo.toml'
                        - 'Cargo.lock'
                      itest:
                        - 'itest/**'
                        - '.github/workflows/ci.yml'

    # Integration tests with Godot runtime
    integration-tests:
        name: integration tests
        runs-on: blaze/macos-latest
        needs: [lint, changes]
        if: |
            needs.changes.outputs.library == 'true' ||
            needs.changes.outputs.itest == 'true'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: |
                      . -> target
                      itest/rust -> target

            - name: Install Godot
              uses: chickensoft-games/setup-godot@v2
              with:
                  version: ${{ env.GODOT_VERSION }}
                  use-dotnet: false
                  include-templates: false

            - name: Cache Godot imports
              uses: actions/cache@v4
              with:
                  path: itest/godot/.godot
                  key: ${{ runner.os }}-godot-imports-itest-${{ hashFiles('itest/godot/**/*.import') }}
                  restore-keys: |
                      ${{ runner.os }}-godot-imports-itest-

            - name: Build integration test library
              run: cargo build --manifest-path itest/rust/Cargo.toml

            - name: Import Godot project
              working-directory: itest/godot
              run: godot --editor --headless --quit || true

            - name: Run integration tests
              working-directory: itest
              env:
                  GODOT4_BIN: godot
              run: ./run-tests.sh
