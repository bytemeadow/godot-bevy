name: ci

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

env:
    CARGO_TERM_COLOR: always
    GODOT_VERSION: "4.5.1"

permissions:
    contents: read
    issues: write
    pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    rust:
        name: build / rust (${{ matrix.platform }})
        runs-on: ${{ matrix.os }}
        env:
            # Disable debug symbols in release builds to save disk space
            CARGO_PROFILE_RELEASE_DEBUG: false
        strategy:
            matrix:
                os:
                    [
                        blaze/compute/ubuntu-latest-amd64,
                        blaze/macos-latest,
                        windows-latest,
                    ]
                include:
                    - os: blaze/compute/ubuntu-latest-amd64
                      platform: linux
                      target: x86_64-unknown-linux-gnu
                      extension: .so
                    - os: blaze/macos-latest
                      platform: macos
                      target: x86_64-apple-darwin
                      extension: .dylib
                    - os: windows-latest
                      platform: windows
                      target: x86_64-pc-windows-msvc
                      extension: .dll

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}
                  components: rustfmt, clippy

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: |
                      . -> target
                      examples/*/rust -> target

            - name: Cache and install Linux dependencies
              if: runner.os == 'linux'
              uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                  packages: libasound2-dev libudev-dev pkg-config
                  version: 1.0

            - name: Check formatting
              run: cargo fmt --all -- --check

            - name: Run clippy
              run: cargo clippy --all-targets -- -D warnings

            - name: Run unit tests (no runtime)
              run: cargo test --lib --bins --examples

            - name: Build release
              run: cargo build --release

            - name: Upload Rust libraries
              uses: actions/upload-artifact@v4
              with:
                  name: rust-libs-${{ runner.os }}
                  path: |
                      target/release/*rust${{ matrix.extension }}
                      target/release/deps/*rust*${{ matrix.extension }}
                  if-no-files-found: error

    changes:
        name: detect changes
        runs-on: ubuntu-latest
        outputs:
            dodge-the-creeps-2d: ${{ steps.filter.outputs.dodge-the-creeps-2d }}
            platformer-2d: ${{ steps.filter.outputs.platformer-2d }}
        steps:
            - uses: actions/checkout@v4
            - uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      dodge-the-creeps-2d:
                        - 'godot-bevy/**'
                        - 'godot-bevy-macros/**'
                        - 'examples/dodge-the-creeps-2d/**'
                        - '.github/workflows/ci.yml'
                        - 'Cargo.toml'
                        - 'Cargo.lock'
                      platformer-2d:
                        - 'godot-bevy/**'
                        - 'godot-bevy-macros/**'
                        - 'examples/platformer-2d/**'
                        - '.github/workflows/ci.yml'
                        - 'Cargo.toml'
                        - 'Cargo.lock'

    examples:
        name: build / ${{ matrix.example }}
        runs-on: blaze/macos-latest
        needs: [rust, changes]
        if: |
            needs.changes.outputs.dodge-the-creeps-2d == 'true' ||
            needs.changes.outputs.platformer-2d == 'true'
        strategy:
            matrix:
                example: ${{ fromJson(needs.changes.outputs.dodge-the-creeps-2d == 'true' && needs.changes.outputs.platformer-2d == 'true' && '["dodge-the-creeps-2d", "platformer-2d"]' || needs.changes.outputs.dodge-the-creeps-2d == 'true' && '["dodge-the-creeps-2d"]' || '["platformer-2d"]') }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: |
                      . -> target
                      examples/*/rust -> target

            - name: Install Godot
              uses: CapsCollective/godot-actions/install-godot@v1.2
              with:
                  godot-version: ${{ env.GODOT_VERSION }}
                  install-templates: true
              id: install-godot

            - name: Cache Godot imports
              uses: actions/cache@v4
              with:
                  path: examples/${{ matrix.example }}/godot/.godot
                  key: ${{ runner.os }}-godot-imports-${{ matrix.example }}-${{ hashFiles(format('examples/{0}/godot/**/*.import', matrix.example)) }}
                  restore-keys: |
                      ${{ runner.os }}-godot-imports-${{ matrix.example }}-

            - name: Download Rust libraries
              uses: actions/download-artifact@v4
              with:
                  path: artifacts/

            - name: Setup cross-platform libraries
              run: |
                  mkdir -p target/{release,debug}

                  # Copy all platform libraries to target directories
                  find artifacts/ -name "*rust*" -type f | while read file; do
                    cp "$file" target/release/ 2>/dev/null || true
                    cp "$file" target/debug/ 2>/dev/null || true
                  done

                  echo "Available libraries:"
                  ls -la target/release/ || echo "No release libraries found"

            - name: Build example Rust library
              run: cargo build --release --manifest-path examples/${{ matrix.example }}/rust/Cargo.toml

            - name: Import Godot project
              working-directory: examples/${{ matrix.example }}/godot
              run: ${{ steps.install-godot.outputs.godot-executable }} --editor --headless --quit || true

            - name: Export for all platforms
              working-directory: examples/${{ matrix.example }}/godot
              run: |
                  mkdir -p exports
                  ${{ steps.install-godot.outputs.godot-executable }} --headless --export-release "Linux/X11" exports/${{ matrix.example }}-linux
                  ${{ steps.install-godot.outputs.godot-executable }} --headless --export-release "Windows Desktop" exports/${{ matrix.example }}-windows.exe
                  ${{ steps.install-godot.outputs.godot-executable }} --headless --export-release "macOS" exports/${{ matrix.example }}-macos.app

            - name: Upload game exports
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.example }}-exports
                  path: examples/${{ matrix.example }}/godot/exports/
                  if-no-files-found: error

    integration-tests:
        name: integration tests
        runs-on: blaze/macos-latest
        needs: [rust]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: |
                      . -> target
                      itest/rust -> target

            - name: Install Godot
              uses: CapsCollective/godot-actions/install-godot@v1.2
              with:
                  godot-version: ${{ env.GODOT_VERSION }}
              id: install-godot

            - name: Download Rust libraries
              uses: actions/download-artifact@v4
              with:
                  path: artifacts/

            - name: Setup cross-platform libraries
              run: |
                  mkdir -p target/{release,debug}

                  # Copy all platform libraries to target directories
                  find artifacts/ -name "*rust*" -type f | while read file; do
                    cp "$file" target/release/ 2>/dev/null || true
                    cp "$file" target/debug/ 2>/dev/null || true
                  done

            - name: Cache Godot imports
              uses: actions/cache@v4
              with:
                  path: itest/godot/.godot
                  key: ${{ runner.os }}-godot-imports-itest-${{ hashFiles('itest/godot/**/*.import') }}
                  restore-keys: |
                      ${{ runner.os }}-godot-imports-itest-

            - name: Build integration test library
              run: cargo build --manifest-path itest/rust/Cargo.toml

            - name: Import Godot project
              working-directory: itest/godot
              run: ${{ steps.install-godot.outputs.godot-executable }} --editor --headless --quit || true

            - name: Run integration tests
              working-directory: itest
              env:
                  GODOT4_BIN: ${{ steps.install-godot.outputs.godot-executable }}
              run: ./run-tests.sh
