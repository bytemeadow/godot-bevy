name: benchmarks

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "godot-bevy/**"
      - "godot-bevy-macros/**"
      - "itest/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/benchmarks.yml"
      - ".github/scripts/benchmarks-compare.py"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  GODOT_VERSION: "4.5.1"
  # Shared target dir so baseline (worktree) and PR builds share cache and avoid double compile time
  CARGO_TARGET_DIR: ${{ github.workspace }}/target

permissions:
  contents: read

jobs:
  benchmarks:
    runs-on: ${{ github.event_name == 'workflow_dispatch' && 'ubuntu-latest' || 'blaze/compute/ubuntu-latest-amd64' }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: . -> target

      - name: Install Linux dependencies
        run: |
          sudo apt-get update || true
          sudo apt-get install -y libasound2-dev libudev-dev pkg-config

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: false

      # ── Baseline (base branch via worktree) ─────────────────────────

      - name: Build baseline
        if: github.event_name == 'pull_request'
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: |
          git worktree add ../baseline "$BASE_SHA"
          cd ../baseline/itest/rust && cargo build --release

      - name: Run baseline benchmarks
        if: github.event_name == 'pull_request'
        working-directory: ../baseline/itest
        env:
          GODOT4_BIN: godot
          BENCHMARK_JSON: "1"
          BENCHMARK_JSON_PATH: baseline.json
        run: |
          # Shared target dir is in main workspace; use absolute path so Godot finds the .so
          cat > godot/itest.gdextension << EOF
          [configuration]
          entry_symbol = "godot_bevy_itest"
          compatibility_minimum = 4.2

          [libraries]
          linux.debug.x86_64 = "$GITHUB_WORKSPACE/target/release/libgodot_bevy_itest.so"
          linux.release.x86_64 = "$GITHUB_WORKSPACE/target/release/libgodot_bevy_itest.so"
          EOF

          mkdir -p godot/.godot
          echo "res://itest.gdextension" > godot/.godot/extension_list.cfg

          "$GODOT4_BIN" --headless --path godot --import --quit || true
          "$GODOT4_BIN" --headless --path godot addons/godot-bevy/test/BenchRunner.tscn --quit-after 30000 2>&1 | tee baseline-output.txt

          if [ ! -f baseline.json ]; then
            sed -n '/===BENCHMARK_JSON_START===/,/===BENCHMARK_JSON_END===/p' baseline-output.txt | \
              sed '1d;$d' > baseline.json
          fi

          jq empty baseline.json || { echo "Error: Invalid baseline JSON"; exit 1; }

      - name: Copy baseline results
        if: github.event_name == 'pull_request'
        run: cp ../baseline/itest/baseline.json itest/baseline.json

      - name: Cleanup worktree
        if: always() && github.event_name == 'pull_request'
        run: git worktree remove ../baseline --force 2>/dev/null || true

      # ── PR branch ───────────────────────────────────────────────────

      - name: Build PR branch
        run: cd itest/rust && cargo build --release

      - name: Run PR benchmarks
        working-directory: itest
        env:
          GODOT4_BIN: godot
          BENCHMARK_JSON: "1"
          BENCHMARK_JSON_PATH: bench-results.json
        run: |
          cat > godot/itest.gdextension << 'EOF'
          [configuration]
          entry_symbol = "godot_bevy_itest"
          compatibility_minimum = 4.2

          [libraries]
          linux.debug.x86_64 = "res://../../target/release/libgodot_bevy_itest.so"
          linux.release.x86_64 = "res://../../target/release/libgodot_bevy_itest.so"
          EOF

          mkdir -p godot/.godot
          echo "res://itest.gdextension" > godot/.godot/extension_list.cfg

          "$GODOT4_BIN" --headless --path godot --import --quit || true
          "$GODOT4_BIN" --headless --path godot addons/godot-bevy/test/BenchRunner.tscn --quit-after 30000 2>&1 | tee bench-output.txt

          if [ ! -f bench-results.json ]; then
            sed -n '/===BENCHMARK_JSON_START===/,/===BENCHMARK_JSON_END===/p' bench-output.txt | \
              sed '1d;$d' > bench-results.json
          fi

          jq empty bench-results.json || { echo "Error: Invalid benchmark JSON"; exit 1; }

      # ── Compare and upload ──────────────────────────────────────────

      - name: Compare results
        if: github.event_name == 'pull_request'
        run: |
          python3 .github/scripts/benchmarks-compare.py \
            itest/baseline.json \
            itest/bench-results.json \
            itest/comparison.json

      - name: Save PR context
        if: github.event_name == 'pull_request'
        run: echo "${{ github.event.pull_request.number }}" > itest/pr_number.txt

      - name: Upload benchmark artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            itest/comparison.json
            itest/pr_number.txt
