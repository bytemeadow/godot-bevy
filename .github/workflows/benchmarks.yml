name: benchmarks

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "godot-bevy/**"
      - "godot-bevy-macros/**"
      - "itest/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/benchmarks.yml"
      - ".github/scripts/benchmarks-compare.py"
      - ".github/scripts/benchmarks-merge.py"
      - ".github/scripts/benchmarks-assert-names.py"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  GODOT_VERSION: "4.5.1"
  # Shared target dir so baseline (worktree) and PR builds share cache and avoid double compile time
  CARGO_TARGET_DIR: ${{ github.workspace }}/target

permissions:
  contents: read

jobs:
  benchmarks:
    runs-on: ${{ github.event_name == 'workflow_dispatch' && 'ubuntu-latest' || 'blaze/compute/ubuntu-latest-amd64' }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: . -> target

      - name: Install Linux dependencies
        run: |
          sudo apt-get update || true
          sudo apt-get install -y libasound2-dev libudev-dev pkg-config

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          use-dotnet: false
          include-templates: false

      # ── Baseline (base branch via worktree) ─────────────────────────

      - name: Build baseline
        if: github.event_name == 'pull_request'
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: |
          git worktree add ../baseline "$BASE_SHA"
          BASELINE_ROOT="${{ github.workspace }}/../baseline"
          BASELINE_BENCH_FILE="$BASELINE_ROOT/itest/rust/src/benchmarks.rs"
          BASELINE_BENCH_BACKUP="$BASELINE_ROOT/itest/rust/src/benchmarks.rs.baseline"
          PR_BENCH_FILE="${{ github.workspace }}/itest/rust/src/benchmarks.rs"

          cp "$BASELINE_BENCH_FILE" "$BASELINE_BENCH_BACKUP"
          cp "$PR_BENCH_FILE" "$BASELINE_BENCH_FILE"

          cd "$BASELINE_ROOT/itest/rust"
          cargo clean --release -p godot-bevy -p godot-bevy-test -p godot-bevy-itest

          if cargo build --release; then
            echo "Baseline build succeeded with PR benchmark definitions."
          else
            echo "PR benchmark definitions failed on baseline; falling back to baseline benchmarks."
            cp "$BASELINE_BENCH_BACKUP" "$BASELINE_BENCH_FILE"
            cargo clean --release -p godot-bevy -p godot-bevy-test -p godot-bevy-itest
            cargo build --release
          fi

      - name: Run baseline benchmarks
        if: github.event_name == 'pull_request'
        working-directory: ../baseline/itest
        env:
          GODOT4_BIN: godot
        run: |
          # Shared target dir is in main workspace; use absolute path so Godot finds the .so
          cat > godot/itest.gdextension << EOF
          [configuration]
          entry_symbol = "godot_bevy_itest"
          compatibility_minimum = 4.2

          [libraries]
          linux.debug.x86_64 = "$GITHUB_WORKSPACE/target/release/libgodot_bevy_itest.so"
          linux.release.x86_64 = "$GITHUB_WORKSPACE/target/release/libgodot_bevy_itest.so"
          EOF

          mkdir -p godot/.godot
          echo "res://itest.gdextension" > godot/.godot/extension_list.cfg

          "$GODOT4_BIN" --headless --path godot --import --quit || true
          for run in 1 2; do
            BASELINE_RUN_JSON="${{ github.workspace }}/itest/baseline-run${run}.json"
            BASELINE_RUN_LOG="baseline-output-${run}.txt"

            BENCHMARK_JSON=1 BENCHMARK_JSON_PATH="$BASELINE_RUN_JSON" \
              "$GODOT4_BIN" --headless --path godot addons/godot-bevy/test/BenchRunner.tscn --quit-after 30000 \
              2>&1 | tee "$BASELINE_RUN_LOG"

            if [ ! -f "$BASELINE_RUN_JSON" ]; then
              sed -n '/===BENCHMARK_JSON_START===/,/===BENCHMARK_JSON_END===/p' "$BASELINE_RUN_LOG" | \
                sed '1d;$d' > "$BASELINE_RUN_JSON"
            fi

            jq empty "$BASELINE_RUN_JSON" || { echo "Error: Invalid baseline JSON for run ${run}"; exit 1; }
          done

          python3 "${{ github.workspace }}/.github/scripts/benchmarks-merge.py" \
            "${{ github.workspace }}/itest/baseline.json" \
            "${{ github.workspace }}/itest/baseline-run1.json" \
            "${{ github.workspace }}/itest/baseline-run2.json"

          jq empty "${{ github.workspace }}/itest/baseline.json" || { echo "Error: Invalid merged baseline JSON"; exit 1; }
          python3 "${{ github.workspace }}/.github/scripts/benchmarks-assert-names.py" \
            rust/src/benchmarks.rs \
            "${{ github.workspace }}/itest/baseline.json"

      - name: Cleanup worktree
        if: always() && github.event_name == 'pull_request'
        run: git worktree remove ../baseline --force 2>/dev/null || true

      # ── PR branch ───────────────────────────────────────────────────

      - name: Build PR branch
        run: |
          cd itest/rust
          cargo clean --release -p godot-bevy -p godot-bevy-test -p godot-bevy-itest
          cargo build --release

      - name: Run PR benchmarks
        working-directory: itest
        env:
          GODOT4_BIN: godot
        run: |
          cat > godot/itest.gdextension << 'EOF'
          [configuration]
          entry_symbol = "godot_bevy_itest"
          compatibility_minimum = 4.2

          [libraries]
          linux.debug.x86_64 = "res://../../target/release/libgodot_bevy_itest.so"
          linux.release.x86_64 = "res://../../target/release/libgodot_bevy_itest.so"
          EOF

          mkdir -p godot/.godot
          echo "res://itest.gdextension" > godot/.godot/extension_list.cfg

          "$GODOT4_BIN" --headless --path godot --import --quit || true
          for run in 1 2; do
            BENCH_RUN_JSON="bench-results-run${run}.json"
            BENCH_RUN_LOG="bench-output-${run}.txt"

            BENCHMARK_JSON=1 BENCHMARK_JSON_PATH="$BENCH_RUN_JSON" \
              "$GODOT4_BIN" --headless --path godot addons/godot-bevy/test/BenchRunner.tscn --quit-after 30000 \
              2>&1 | tee "$BENCH_RUN_LOG"

            if [ ! -f "$BENCH_RUN_JSON" ]; then
              sed -n '/===BENCHMARK_JSON_START===/,/===BENCHMARK_JSON_END===/p' "$BENCH_RUN_LOG" | \
                sed '1d;$d' > "$BENCH_RUN_JSON"
            fi

            jq empty "$BENCH_RUN_JSON" || { echo "Error: Invalid benchmark JSON for run ${run}"; exit 1; }
          done

          python3 "${{ github.workspace }}/.github/scripts/benchmarks-merge.py" \
            bench-results.json \
            bench-results-run1.json \
            bench-results-run2.json

          jq empty bench-results.json || { echo "Error: Invalid merged benchmark JSON"; exit 1; }
          python3 "${{ github.workspace }}/.github/scripts/benchmarks-assert-names.py" \
            rust/src/benchmarks.rs \
            bench-results.json

      # ── Compare and upload ──────────────────────────────────────────

      - name: Compare results
        if: github.event_name == 'pull_request'
        run: |
          python3 .github/scripts/benchmarks-compare.py \
            itest/baseline.json \
            itest/bench-results.json \
            itest/comparison.json

      - name: Save PR context
        if: github.event_name == 'pull_request'
        run: echo "${{ github.event.pull_request.number }}" > itest/pr_number.txt

      - name: Upload benchmark artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            itest/comparison.json
            itest/pr_number.txt
