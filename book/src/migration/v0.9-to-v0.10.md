# Migration Guide: v0.9 to v0.10
This guide covers breaking changes and new features when upgrading from godot-bevy 0.9.x to 0.10.0.




## Table of Contents

Breaking changes:

- [Upgrade to Bevy 0.17](#breaking-upgrade-to-bevy-017)
- [Custom scene tree relationships](#breaking-custom-scene-tree-relationships)
- [NodeTreeView::from_node now returns a Result type](#breaking-nodetreeviewfrom_node-now-returns-a-result-type)

Other changes:

- [New GodotScene with_signal_connection builder method](#new-godotscene-with_signal_connection-builder-method)
- [Profiling cleanup with zero dependency leakage](#profiling-cleanup-with-zero-dependency-leakage)




## Breaking: Upgrade to Bevy 0.17

âœ¨ Godot-Bevy is now up to date with Bevy 0.17! âœ¨

Here is the Bevy 0.16 to 0.17 migration guide for reference: https://bevy.org/learn/migration-guides/0-16-to-0-17/

The biggest difference is that Godot-Bevy now uses `Message` instead of `Event`.

### Migration Path

#### Cargo.toml

ğŸ—‘ï¸ Before:
```
bevy = { version = "0.16", default-features = false, features = ["bevy_state"] }
bevy_asset_loader = "0.23.0"
```

ğŸŸ¢ After:
```toml
bevy = { version = "0.17", default-features = false, features = ["bevy_state"] }
bevy_asset_loader = "0.24.0-rc.1"
```

#### Event to Message

ğŸ—‘ï¸ Before:
```rust,ignore
#[derive(Event, Debug)]
pub enum SceneOperationEvent {
```

ğŸŸ¢ After:
```rust,ignore
#[derive(Message, Debug)]
pub enum SceneOperationMessage {
```

ğŸ—‘ï¸ Before:
```rust,ignore
app.add_event::<SceneOperationEvent>()
```

ğŸŸ¢ After:
```rust,ignore
app.add_message::<SceneOperationMessage>()
```

ğŸ—‘ï¸ Before:
```rust,ignore
mut operation_events: EventReader<SceneOperationEvent>,
```

ğŸŸ¢ After:
```rust,ignore
mut operation_events: MessageReader<SceneOperationMessage>,
```

### Migration Checklist

- [ ] Update Bevy to `0.17`.
- [ ] Update Bevy Asset Loader to `0.24.0-rc.1`.
- [ ] Replace usages of `Event` with `Message`.




## Breaking: Custom Scene Tree Relationships

Godot's scene tree is now represented by a custom ECS relationship:
`GodotChildOf` / `GodotChildren`. The built-in Bevy `ChildOf` / `Children`
relationship is no longer used for scene tree mirroring.

This avoids conflicts with other plugins that use Bevy's hierarchy for their own
purposes (physics, AI, scene graphs, etc.).

### Migration Path

#### Queries and Traversal

ğŸ—‘ï¸ Before:
```rust,ignore
fn parent_of(entity: Entity, query: Query<&ChildOf>) -> Option<Entity> {
    query.get(entity).ok().map(|parent| parent.parent())
}

fn children_of(entity: Entity, query: Query<&Children>) -> Vec<Entity> {
    query
        .get(entity)
        .map(|children| children.iter().copied().collect())
        .unwrap_or_default()
}
```

ğŸŸ¢ After:
```rust,ignore
fn parent_of(entity: Entity, query: Query<&GodotChildOf>) -> Option<Entity> {
    query.get(entity).ok().map(|parent| parent.get())
}

fn children_of(entity: Entity, query: Query<&GodotChildren>) -> Vec<Entity> {
    query
        .get(entity)
        .map(|children| children.iter().copied().collect())
        .unwrap_or_default()
}
```

#### Configuration

The `scene_tree_add_child_relationship` attribute and
`GodotSceneTreePlugin { add_child_relationship: ... }` have been removed.

If you want children to outlive their parents, use the new
`scene_tree_auto_despawn_children` attribute (or the plugin config).

ğŸ—‘ï¸ Before:
```rust,ignore
#[bevy_app(scene_tree_add_child_relationship = false)]
fn build_app(app: &mut App) {}

app.add_plugins(GodotSceneTreePlugin {
    add_child_relationship: true,
});
```

ğŸŸ¢ After:
```rust,ignore
#[bevy_app(scene_tree_auto_despawn_children = false)]
fn build_app(app: &mut App) {}

app.add_plugins(GodotSceneTreePlugin {
    auto_despawn_children: true,
});
```

### Breaking changes
- Bevy `ChildOf` / `Children` are no longer used for Godot scene tree hierarchy.
- `scene_tree_add_child_relationship` was removed.
- New `scene_tree_auto_despawn_children` configuration option.

### Migration Checklist
- [ ] Replace `ChildOf` / `Children` queries with `GodotChildOf` / `GodotChildren`.
- [ ] Remove `scene_tree_add_child_relationship` usage.
- [ ] Use `scene_tree_auto_despawn_children` if you need to keep children alive on parent despawn.



## Breaking: NodeTreeView::from_node now returns a Result type
`NodeTreeView::from_node` derive macro now returns a `Result<Self, NodeTreeViewError>` type to avoid surprise panic in
user code if a godot node is not found.

### Migration Path
Use `match`, `if let` or `unwrap` to handle the `Result` type returned by `NodeTreeView::from_node`.

#### Example 1:

ğŸ—‘ï¸ Before:
```rust,ignore
let mut mob_nodes = MobNodes::from_node(mob);
```

ğŸŸ¢ After:
```rust,ignore
let mut mob_nodes = MobNodes::from_node(mob).unwrap();
```

#### Example 2:

ğŸ—‘ï¸ Before:
```rust,ignore
match std::panic::catch_unwind(std::panic::AssertUnwindSafe(|| MenuUi::from_node(root))) {
    Ok(menu_ui) => {
        info!("MainMenu: Successfully found menu nodes");
    }
    Err(_) => {
        debug!("MainMenu: Menu nodes not ready yet, will retry next frame");
    }
}
```

ğŸŸ¢ After:
```rust,ignore
match MenuUi::from_node(root) {
    Ok(menu_ui) => {
        info!("MainMenu: Successfully found menu nodes");
    }
    Err(_) => {
        debug!("MainMenu: Menu nodes not ready yet, will retry next frame");
    }
}
```

### Breaking changes
Return type of `NodeTreeView::from_node` derive macro changed from `Self` to `Result<Self, NodeTreeViewError>`.

### Migration Checklist
- [ ] Use `match`, `if let` or `unwrap` to handle the `Result` type returned by `NodeTreeView::from_node`.




## New GodotScene `with_signal_connection` builder method

A new `with_signal_connection` builder method has been added to `GodotScene` to simplify connecting signals
to children nodes after a scene has been loaded. 
See [Attaching signals to Godot scenes](../input/signals.md#attaching-signals-to-godot-scenes) for more details.

### Migration Path

ğŸ—‘ï¸ Before:
```rust,ignore
fn plugin(app: &mut App) {
    // ...
    app.add_systems(Update, spawn_mob),
    app.add_systems(Update, initialize_new_mob),
    // ...
}

#[main_thread_system]
fn spawn_mob(...) {
    // ...
    commands
        .spawn_empty()
        .insert(Mob { direction })
        .insert(transform)
        .insert(GodotScene::from_handle(assets.mob_scn.clone()))
}

#[main_thread_system]
fn initialize_new_mob(entities: Query<(Entity), Added<Mob>>, typed: TypedGodotSignals<MobScreenExited>) {
    for entity in entities.iter() {
        // ...
        // Connect typed event with entity attachment so we can destroy the entity when it goes off-screen
        typed.connect_map(
            &mut mob_nodes.visibility_notifier_node_handle,
            VisibleOnScreenNotifier2DSignals::SCREEN_EXITED,
            Some(entity),
            |_args, _node, ent| {
                Some(MobScreenExited {
                    entity: ent.expect("entity was provided"),
                })
            },
        );
        // ...
    }
}
```

ğŸŸ¢ After:
```rust,ignore
fn plugin(app: &mut App) {
    // ...
    app.add_systems(Update, spawn_mob),
    // ...
}

#[main_thread_system]
fn spawn_mob(...) {
    // ...
    commands
        .spawn_empty()
        .insert(Mob { direction })
        .insert(transform)
        .insert(
            GodotScene::from_handle(assets.mob_scn.clone())
                // Schedule signal connection on scene load
                // No need for separate mob initialization system
                .with_signal_connection(
                    "VisibleOnScreenNotifier2D",
                    "screen_exited",
                    |_args, _handle, entity| {
                        Some(MobScreenExited {
                            entity: entity.expect("entity was provided"),
                        })
                    },
                ),
        )
        .insert(AnimationState::default());
}
```

### Migration Checklist

- [ ] In some cases, replace `connect_map` with `GodotScene::with_signal_connection`.




## Profiling cleanup with zero dependency leakage

The Tracy profiling utility has been replaced with a new module that encapsulates
all Tracy-specific code so that the proc macro never needs to reference Tracy types directly.
This prevents Tracy dependencies from leaking into user code while maintaining full profiling support.

### Migration Path

ğŸ—‘ï¸ Before:
```rust,ignore
#![allow(unexpected_cfgs)] // silence potential `tracy_trace` feature config warning brought in by `bevy_app` macro
```

ğŸŸ¢ After:
```rust,ignore
// Removed: #![allow(unexpected_cfgs)]
```

### Migration Checklist

- [ ] You can now remove `#![allow(unexpected_cfgs)]` from your code.
