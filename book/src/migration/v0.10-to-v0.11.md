# Migration Guide: v0.10 to v0.11
This guide covers breaking changes and new behavior when upgrading from godot-bevy 0.10.x to 0.11.0.

## Table of Contents

Breaking changes:

- [Collisions API redesigned](#breaking-collisions-api-redesigned)
- [Main-thread access is now explicit via GodotAccess](#breaking-main-thread-access-is-now-explicit-via-godotaccess)
- [GodotNodeHandle is ID-only; GodotNodeId removed](#breaking-godotnodehandle-is-id-only-godotnodeid-removed)
- [Signal connection APIs now take GodotAccess](#breaking-signal-connection-apis-now-take-godotaccess)


## Breaking: Collisions API redesigned

The collision API has been redesigned, providing a cleaner separation between querying 
current collision state and reacting to collision events.

### Collisions component removed

The per-entity `Collisions` component has been replaced with a `Collisions` system parameter
for querying global collision state.

Before:

```rust,ignore
fn check_player_death(
    player: Query<(&Player, &Collisions)>,
) {
    for (player, collisions) in player.iter() {
        for &other in collisions.colliding() {
            // handle collision
        }
        for &other in collisions.recent_collisions() {
            // handle new collision this frame
        }
    }
}
```

After:

```rust,ignore
fn check_player_death(
    player: Query<(Entity, &Player)>,
    collisions: Collisions,
) {
    for (entity, player) in player.iter() {
        // Query current collisions
        for &other in collisions.colliding_with(entity) {
            // handle collision
        }
        // Check specific pair
        if collisions.contains(entity, enemy) {
            // player is touching enemy
        }
    }
}
```

### New collision events for change detection

To detect when collisions start or end, use the new `CollisionStarted` and `CollisionEnded`
events instead of querying per-frame.

As messages:

```rust,ignore
fn handle_hits(mut started: MessageReader<CollisionStarted>) {
    for event in started.read() {
        println!("{:?} hit {:?}", event.entity1, event.entity2);
    }
}
```

As observers:

```rust,ignore
app.add_observer(|trigger: Trigger<CollisionStarted>| {
    let event = trigger.event();
    println!("{:?} hit {:?}", event.entity1, event.entity2);
});
```

### CollisionMessage removed

The internal `CollisionMessage` type has been replaced with the public `CollisionStarted`
and `CollisionEnded` event types.

### Summary of changes

| Old API | New API |
|---------|---------|
| `Query<&Collisions>` | `Collisions` system param |
| `collisions.colliding()` | `collisions.colliding_with(entity)` |
| `collisions.recent_collisions()` | `MessageReader<CollisionStarted>` |
| `CollisionMessage` | `CollisionStarted` / `CollisionEnded` |


## Breaking: Main-thread access is now explicit via GodotAccess

The `#[main_thread_system]` macro has been removed. Systems that call Godot APIs must include
`GodotAccess` in their parameters. `GodotAccess` is a `NonSend` SystemParam that pins the system
to the main thread.

Before:

```rust,ignore
#[main_thread_system]
fn update_ui(mut q: Query<&mut GodotNodeHandle>) {
    for mut handle in &mut q {
        if let Some(mut label) = handle.try_get::<Label>() {
            label.set_text("Hi");
        }
    }
}
```

After:

```rust,ignore
fn update_ui(q: Query<&GodotNodeHandle>, mut godot: GodotAccess) {
    for handle in &q {
        if let Some(mut label) = godot.try_get::<Label>(*handle) {
            label.set_text("Hi");
        }
    }
}
```

Notes:

- `SceneTreeRef` is also a `NonSend` SystemParam. If a system already takes `SceneTreeRef` and does
  not call Godot APIs, you do not need an extra `GodotAccess` parameter.
- If you only have an `InstanceId`, use `GodotAccess::try_get_instance_id` or `get_instance_id`.


## Breaking: GodotNodeHandle is ID-only; GodotNodeId removed

`GodotNodeId` has been removed. `GodotNodeHandle` is now a lightweight, copyable wrapper around
an `InstanceId`.

Before:

```rust,ignore
struct QuitRequested { source: GodotNodeId }
```

After:

```rust,ignore
struct QuitRequested { source: GodotNodeHandle }
```

Constructors:

Before:

```rust,ignore
let handle = GodotNodeHandle::from_id(node_id);
```

After:

```rust,ignore
let handle = GodotNodeHandle::from_instance_id(node_id);
// or: let handle: GodotNodeHandle = node_id.into();
```

If you were using `GodotNodeHandle::get` or `try_get` directly, switch to
`GodotAccess::get` or `GodotAccess::try_get` instead.

## Breaking: Legacy untyped signals removed

The untyped signal API has been removed:

- `GodotSignalsPlugin`
- `GodotSignals` SystemParam
- `GodotSignal` message
- `connect_godot_signal`

Use typed signals instead (`GodotTypedSignalsPlugin::<T>` + `TypedGodotSignals<T>`).

## Migration Checklist

- [ ] Replace `Query<&Collisions>` with `Collisions` system param.
- [ ] Replace `collisions.colliding()` with `collisions.colliding_with(entity)`.
- [ ] Replace `collisions.recent_collisions()` with `MessageReader<CollisionStarted>`.
- [ ] Replace `#[main_thread_system]` with `GodotAccess` parameters where you call Godot APIs.
- [ ] Replace `GodotNodeId` with `GodotNodeHandle`.
- [ ] Replace `handle.get` or `handle.try_get` with `godot.get` or `godot.try_get`.
- [ ] Update signal connection call sites to use queued `connect_map`.
- [ ] Replace legacy untyped signal APIs with typed signals.
